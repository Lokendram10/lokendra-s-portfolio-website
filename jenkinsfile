pipeline {
 agent any
    stages{
         stage('Clone Repository'){
           steps{
             echo 'cloning repository'
             git branch: 'main' , url: 'https://github.com/Lokendram10/lokendra-s-portfolio-website'
            }
          }

         stage('Build Image'){
           steps{
             echo' creating docker image'
             sh ' docker build  -t portfolio:latest .'
            }
          }

         stage('Security Scan'){
           steps{
             echo' scanning using trivy'
             sh ' trivy image --severity HIGH,CRITICAL -f json -o portfolo.json portfolio:latest  '
            }
          }

        stage('Push to  Docker HUb'){
           steps{
             echo'Pushing Image to Docker Hub'
                 withCredentials([usernamePassword(credentialsId: 'dockerhub-creds', 
                 passwordVariable: 'DOCKERHUB_PASSWORD', 
                 usernameVariable: 'DOCKERHUB_USERNAME')]) {
              sh 'docker login -u $DOCKERHUB_USERNAME -p $DOCKERHUB_PASSWORD'
              sh 'docker push lokendradhote64/portfolio:latest'
            }
          }



        stage('Deploy'){
           steps{
             echo'deploying'
           sh' docker compose up -d --build'
            }
          }

  }
}
